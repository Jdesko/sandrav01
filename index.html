<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Solar Residencial</title>
    <style>
        :root {
            --primary: #4285f4;
            --generation: #34a853;
            --import: #ea4335;
            --consumption: #fbbc05;
            --voltage: #9c27b0;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
        }
        
        h1 {
            color: var(--primary);
        }
        
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 150px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .generation { color: var(--generation); }
        .consumption { color: var(--consumption); }
        .grid { color: var(--import); }
        .voltage { color: var(--voltage); }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .error {
            color: #d32f2f;
            margin: 15px 0;
            min-height: 20px;
        }
        
        .last-update {
            color: #666;
            margin-top: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Monitoramento Solar Residencial</h1>
    <p>Dados em tempo real via Tuya Cloud</p>
    
    <div class="dashboard">
        <div class="card">
            <h3>Produção Solar</h3>
            <div class="value generation" id="generation">-- W</div>
        </div>
        
        <div class="card">
            <h3>Consumo</h3>
            <div class="value consumption" id="consumption">-- W</div>
        </div>
        
        <div class="card">
            <h3>Conexão com a Rede</h3>
            <div class="value grid" id="grid">-- W</div>
        </div>
        
        <div class="card">
            <h3>Voltagem</h3>
            <div class="value voltage" id="voltage">-- V</div>
        </div>
    </div>
    
    <div id="error" class="error"></div>
    <button id="refresh">Atualizar Dados</button>
    <div id="lastUpdate" class="last-update">Última atualização: --</div>

    <script>
        // Configuração - Substitua com seu deviceId
        const CONFIG = {
            deviceId: "bfe2a8f17ebd1d39d1hctm", // Seu deviceId real
            proxyUrl: "http://localhost:3000/api/device-status" // URL do seu proxy
        };

        // Elementos da interface
        const elements = {
            generation: document.getElementById('generation'),
            consumption: document.getElementById('consumption'),
            grid: document.getElementById('grid'),
            voltage: document.getElementById('voltage'),
            error: document.getElementById('error'),
            refresh: document.getElementById('refresh'),
            lastUpdate: document.getElementById('lastUpdate')
        };

        // Formata números e datas
        const format = {
            number: (num) => num ? Math.round(num) : '--',
            voltage: (num) => num ? parseFloat(num).toFixed(1) : '--',
            time: () => new Date().toLocaleTimeString('pt-BR')
        };

        // Mostra erros na interface
        function showError(message) {
            elements.error.textContent = message;
            console.error(message);
        }

        // Busca dados do dispositivo via proxy
        async function fetchData() {
            try {
                elements.error.textContent = "Carregando...";
                
                const response = await fetch(`${CONFIG.proxyUrl}?deviceId=${CONFIG.deviceId}`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                return data.result || [];
                
            } catch (error) {
                showError("Falha ao buscar dados: " + error.message);
                return null;
            }
        }

        // Atualiza a interface com os dados
        async function updateUI() {
            const deviceData = await fetchData();
            if (!deviceData) return;
            
            // Extrai valores (ajuste os códigos conforme seu dispositivo)
            const generation = deviceData.find(item => item.code === 'cur_power1')?.value || 0;
            const grid = deviceData.find(item => item.code === 'cur_power2')?.value || 0;
            const voltage = deviceData.find(item => item.code === 'cur_voltage1')?.value || 0;
            
            // Calcula consumo (produção + energia da rede)
            const consumption = generation + Math.max(0, grid);
            
            // Atualiza a interface
            elements.generation.textContent = `${format.number(generation)} W`;
            elements.grid.textContent = `${format.number(grid)} W`;
            elements.consumption.textContent = `${format.number(consumption)} W`;
            elements.voltage.textContent = `${format.voltage(voltage)} V`;
            elements.lastUpdate.textContent = `Última atualização: ${format.time()}`;
            elements.error.textContent = "";
        }

        // Eventos
        elements.refresh.addEventListener('click', updateUI);
        
        // Atualização automática a cada 10 segundos
        let refreshInterval;
        function startAutoRefresh() {
            updateUI(); // Atualiza imediatamente
            refreshInterval = setInterval(updateUI, 10000); // 10 segundos
        }
        
        // Inicia quando a página carrega
        document.addEventListener('DOMContentLoaded', startAutoRefresh);
    </script>
</body>
</html>